<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/><title>Carrito</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="DiseñoPag.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body>
<nav class="navbar navbar-expand navbar-custom sticky-top">
    <div class="container">
      <a class="navbar-brand" href="index.html"><i class="bi bi-fire text-warning me-2"></i>Rostisería SC</a>
      <div class="d-flex align-items-center ms-auto">
        <div class="d-none d-md-flex align-items-center me-3">
            <a class="nav-link mx-2" href="index.html">Inicio</a>
            <a class="nav-link mx-2" href="catalogo.html">Catálogo</a>
            <span id="navLoginContainer"><a class="nav-link mx-2" href="login.html">Ingresar</a></span>
        </div>
        <a class="btn position-relative me-3 text-light" href="carrito.html">
            <i class="bi bi-cart3 fs-5"></i><span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="mini-cart-count">0</span>
        </a>
        <div class="dropdown">
            <button class="btn btn-outline-light border-0" data-bs-toggle="dropdown"><i class="bi bi-list fs-4"></i></button>
            <ul class="dropdown-menu dropdown-menu-end shadow-lg">
                <li class="d-md-none"><a class="dropdown-item" href="catalogo.html">Ir al Catálogo</a></li>
                <li class="d-md-none"><a class="dropdown-item" href="login.html" id="mobileLoginLink">Ingresar</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="nosotros.html">Nosotros</a></li>
                <li><a class="dropdown-item" href="contacto.html">Contacto</a></li>
                <li id="navAdminItem" class="d-none"><hr class="dropdown-divider"><a class="dropdown-item text-warning fw-bold" href="admin.html">Panel Admin</a></li>
            </ul>
        </div>
      </div>
    </div>
</nav>

<section class="container my-5">
    <h2 class="section-title">Tu Pedido</h2>
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm border-0"><div class="card-body">
                <table class="table align-middle"><thead class="table-light"><tr><th>Producto</th><th>Cant</th><th>Precio</th><th>Subtotal</th><th></th></tr></thead><tbody id="cartTable"></tbody></table>
                <p id="msgEmpty" class="text-center text-muted my-3"></p>
            </div></div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm border-0 p-3">
                <h4 class="mb-3">Datos de Envío</h4>
                <form id="orderForm">
                    <input class="form-control mb-2" id="cName" placeholder="Nombre" required>
                    <input class="form-control mb-2" id="cEmail" placeholder="Email" type="email" required>
                    <input class="form-control mb-2" id="cPhone" placeholder="Teléfono" required>
                    <input class="form-control mb-2" id="cAddr" placeholder="Dirección" required>
                    <textarea class="form-control mb-3" id="cNote" placeholder="Notas"></textarea>
                    <div class="d-flex justify-content-between mb-3 fw-bold fs-5"><span>Total:</span><span id="cTotal" class="text-primary">$0</span></div>
                    <button class="btn btn-primary-custom w-100">Confirmar Pedido</button>
                </form>
            </div>
        </div>
    </div>
</section>

<footer class="footer-section text-center"><p class="mb-0">&copy; 2025 Rostisería SC</p></footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="api_utils.js"></script>
<script src="TiempoSesion.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        let cart = getCart();
        const update = () => { document.getElementById('mini-cart-count').textContent=cart.reduce((s,i)=>s+(i.quantity||1),0); }; update();
        const user = getLoggedUser();
        if(user) { 
            if(user.isAdmin) document.getElementById("navAdminItem").classList.remove("d-none");
            document.getElementById("navLoginContainer").innerHTML=`<a class="nav-link mx-2 text-warning" href="#" onclick="clearAuth();window.location.reload()">Salir</a>`;
            if(document.getElementById("mobileLoginLink")) document.getElementById("mobileLoginLink").onclick=()=>{clearAuth();window.location.reload()};
            document.getElementById("cEmail").value = user.email;
        }

        const render = () => {
            const tb = document.getElementById("cartTable"); tb.innerHTML=""; let tot=0;
            if(!cart.length) document.getElementById("msgEmpty").textContent="Carrito vacío";
            cart.forEach((i,x)=>{
                const p=i.price||i.precio||0, q=i.quantity||i.cantidad||1, sub=p*q; tot+=sub;
                tb.innerHTML+=`<tr><td>${i.name||i.nombre}</td><td>${q}</td><td>$${p.toLocaleString("es-CL")}</td><td>$${sub.toLocaleString("es-CL")}</td><td><button class="btn btn-sm text-danger" onclick="rem(${x})"><i class="bi bi-trash"></i></button></td></tr>`;
            });
            document.getElementById("cTotal").textContent="$"+tot.toLocaleString("es-CL");
        };
        window.rem=(i)=>{cart.splice(i,1); saveCart(cart); render(); update();};
        render();

        document.getElementById("orderForm").onsubmit = async (e) => {
            e.preventDefault();
            if(!cart.length) return alert("Carrito vacío");
            const total = cart.reduce((s,i)=>s+((i.price||0)*(i.quantity||1)),0);
            const items = cart.map(i=>({productoId:i.id||i._id, nombre:i.name||i.nombre, precio:i.price||0, cantidad:i.quantity||1}));
            try {
                await apiFetch("/orders", "POST", {
                    customer_name: document.getElementById("cName").value, email: document.getElementById("cEmail").value,
                    phone: document.getElementById("cPhone").value, address: document.getElementById("cAddr").value,
                    note: document.getElementById("cNote").value, items, total
                });
                alert("Pedido Enviado"); clearCart(); window.location.href="index.html";
            } catch(er){ alert("Error: "+er.message); }
        };
    });
</script>
</body>
</html>