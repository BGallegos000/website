<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login - Rostisería SC</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="DiseñoPag.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-md-5">
        <div class="card shadow-sm">
          <div class="card-header bg-dark text-white text-center">Iniciar Sesión</div>
          <div class="card-body">
            <form id="loginForm">
              <input type="email" id="loginEmail" class="form-control mb-2" placeholder="Email" required>
              <input type="password" id="loginPwd" class="form-control mb-2" placeholder="Contraseña" required>
              <button class="btn btn-danger w-100">Ingresar</button>
            </form>
          </div>
          <div class="card-footer text-center">
            <small>¿No tienes cuenta? <a href="#" data-bs-toggle="modal" data-bs-target="#registerModal">Regístrate</a> · <a href="#" id="forgotLink">¿Olvidaste tu contraseña?</a></small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Registro -->
  <div class="modal fade" id="registerModal"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5>Crear cuenta</h5></div>
    <div class="modal-body">
      <form id="registerForm">
        <input type="email" id="registerEmail" class="form-control mb-2" placeholder="Email" required>
        <input type="password" id="registerPwd" class="form-control mb-2" placeholder="Contraseña" required>
        <div class="form-text mb-2">Mínimo 8 caracteres, 1 mayúscula y 1 dígito.</div>
        <button class="btn btn-success w-100">Registrar</button>
      </form>
    </div>
  </div></div></div>

  <div id="toast-container" class="position-fixed top-0 end-0 p-3"></div>

  <script src="TiempoSesion.js"></script>
  <script>
    let users = JSON.parse(localStorage.getItem('rostiseria_users')||'[]');
    const LOCK_KEY = 'rostiseria_lock';
    const TOK_KEY  = 'rostiseria_resetTokens';

    function showToast(msg,color='success'){
      const c=document.getElementById('toast-container');
      const t=document.createElement('div');
      t.className='toast align-items-center text-white bg-'+color+' border-0 mb-2';
      t.innerHTML='<div class="d-flex"><div class="toast-body">'+msg+'</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>';
      c.appendChild(t); new bootstrap.Toast(t).show(); t.addEventListener('hidden.bs.toast',()=>t.remove());
    }
    function validPwd(p){ return /^(?=.*[A-Z])(?=.*\d).{8,}$/.test(p); }
    function getLock(){ try{return JSON.parse(localStorage.getItem(LOCK_KEY)||'{}');}catch(e){return {};}}
    function setLock(x){ localStorage.setItem(LOCK_KEY, JSON.stringify(x)); }

    // Registro con política de contraseña
    document.getElementById('registerForm').addEventListener('submit', e=>{
      e.preventDefault();
      const email=document.getElementById('registerEmail').value.trim();
      const pwd=document.getElementById('registerPwd').value;
      if(users.find(u=>u.email===email)){ showToast('Email ya registrado','danger'); return; }
      if(!validPwd(pwd)){ showToast('Contraseña débil (min 8, 1 mayúscula y 1 dígito)','danger'); return; }
      users.push({email,pwd}); localStorage.setItem('rostiseria_users', JSON.stringify(users));
      showToast('Cuenta creada'); bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
    });

    // Login con bloqueo 5 intentos → 15 minutos
    document.getElementById('loginForm').addEventListener('submit', e=>{
      e.preventDefault();
      const email=document.getElementById('loginEmail').value.trim();
      const pwd=document.getElementById('loginPwd').value;

      let lock=getLock(); const now=Date.now();
      if(lock.until && now<lock.until){ showToast('Demasiados intentos. Intenta más tarde.','danger'); return; }

      const user=users.find(u=>u.email===email && u.pwd===pwd);
      if(user){
        localStorage.setItem('rostiseria_loggedUser', email);
        localStorage.setItem('rostiseria_session', JSON.stringify({lastActivity: Date.now()}));
        setLock({count:0,until:0});
        showToast('Bienvenido '+email);
      }else{
        const count=(lock.count||0)+1; const until = count>=5 ? now + 15*60*1000 : 0;
        setLock({count,until});
        showToast('Credenciales inválidas. Intento '+count+(until?'. Bloqueado 15 min.':''),'danger');
      }
    });

    // Recuperación de contraseña por prompts (sin tocar UI)
    document.getElementById('forgotLink').addEventListener('click', (e)=>{
      e.preventDefault();
      const email = (prompt('Ingresa tu correo registrado:')||'').trim();
      if(!email) return;
      if(!users.some(u=>u.email===email)){ showToast('No existe usuario con ese correo','danger'); return; }

      // Paso 1: enviar código simulado
      const code = Math.random().toString(36).slice(2,8).toUpperCase();
      const tokens = JSON.parse(localStorage.getItem(TOK_KEY)||'{}');
      tokens[email] = { code, expires: Date.now()+15*60*1000 };
      localStorage.setItem(TOK_KEY, JSON.stringify(tokens));
      alert('Código de verificación (simulado): '+code);

      // Paso 2: verificar código y setear nueva contraseña
      const typed = (prompt('Ingresa el código recibido:')||'').trim().toUpperCase();
      if(typed !== code){ showToast('Código inválido','danger'); return; }

      const newPwd = (prompt('Nueva contraseña (min 8, 1 mayúscula y 1 dígito):')||'').trim();
      if(!validPwd(newPwd)){ showToast('La contraseña no cumple la política','danger'); return; }

      users = users.map(u=>u.email===email?({...u,pwd:newPwd}):u);
      localStorage.setItem('rostiseria_users', JSON.stringify(users));
      const t = JSON.parse(localStorage.getItem(TOK_KEY)||'{}'); delete t[email]; localStorage.setItem(TOK_KEY, JSON.stringify(t));
      showToast('Contraseña actualizada. Ya puedes iniciar sesión.');
    });
  </script>

  <script>
  // Claves de storage usadas en todo el sitio
  const K_USERS  = 'rostiseria_users';
  const K_LOGGED = 'rostiseria_loggedUser';
  const K_ADMINS = 'rostiseria_admins';

  // Si no existe la lista de admins, siembra uno por defecto
  (function seedAdminOnce(){
    const admins = JSON.parse(localStorage.getItem(K_ADMINS) || '[]');
    if (!admins.length) {
      localStorage.setItem(K_ADMINS, JSON.stringify(['admin@sc.cl'])); // cambia o agrega los que quieras
    }
  })();

  // Llamar a esto cuando el login sea exitoso (email verificado)
  function onLoginSuccess(email) {
    // guarda la sesión
    localStorage.setItem(K_LOGGED, email);

    // ¿es admin?
    const admins = JSON.parse(localStorage.getItem(K_ADMINS) || '[]');
    const isAdmin = admins.includes((email || '').toLowerCase());

    // redirige según rol
    window.location.href = isAdmin ? 'admin.html' : 'index.html';
  }

  // Si ya está logueado y vuelve al login, dirigirlo de inmediato
  (function autoRedirectIfLogged(){
    const email = localStorage.getItem(K_LOGGED);
    if (!email) return;
    const admins = JSON.parse(localStorage.getItem(K_ADMINS) || '[]');
    const isAdmin = admins.includes(email.toLowerCase());
    window.location.replace(isAdmin ? 'admin.html' : 'index.html');
  })();


  const form = document.getElementById('formLogin'); // ajusta el id si es necesario
  if (form && !form.dataset._wired) {
    form.dataset._wired = '1';
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const email = (document.getElementById('email')?.value || '').trim().toLowerCase();
      const pass  = (document.getElementById('password')?.value || '').trim();

      const users = JSON.parse(localStorage.getItem(K_USERS) || '[]');
      const ok = users.find(u => (u.email || '').toLowerCase() === email && (u.password || '') === pass);
      if (!ok) {
        alert('Correo y/o contraseña inválidos');
        return;
      }
      // login correcto → redirige según rol
      onLoginSuccess(email);
    });
  }
</script>

</body>
</html>
