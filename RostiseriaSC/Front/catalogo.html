<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/><title>Catálogo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="DiseñoPag.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body>
  <nav class="navbar navbar-expand navbar-custom sticky-top">
    <div class="container">
      <a class="navbar-brand" href="index.html"><i class="bi bi-fire text-warning me-2"></i>Rostisería SC</a>
      <div class="d-flex align-items-center ms-auto">
        <div class="d-none d-md-flex align-items-center me-3">
            <a class="nav-link mx-2" href="index.html">Inicio</a>
            <a class="nav-link mx-2 active" href="catalogo.html">Catálogo</a>
            <span id="navLoginContainer"><a class="nav-link mx-2" href="login.html">Ingresar</a></span>
        </div>
        <a class="btn position-relative me-3 text-light" href="carrito.html">
            <i class="bi bi-cart3 fs-5"></i><span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="mini-cart-count">0</span>
        </a>
        <div class="dropdown">
            <button class="btn btn-outline-light border-0" data-bs-toggle="dropdown"><i class="bi bi-list fs-4"></i></button>
            <ul class="dropdown-menu dropdown-menu-end shadow-lg">
                <li class="d-md-none"><a class="dropdown-item" href="catalogo.html">Ir al Catálogo</a></li>
                <li class="d-md-none"><a class="dropdown-item" href="login.html" id="mobileLoginLink">Ingresar</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="nosotros.html">Nosotros</a></li>
                <li><a class="dropdown-item" href="contacto.html">Contacto</a></li>
                <li id="navAdminItem" class="d-none"><hr class="dropdown-divider"><a class="dropdown-item text-warning fw-bold" href="admin.html">Panel Admin</a></li>
            </ul>
        </div>
      </div>
    </div>
  </nav>

  <section class="py-5 container">
      <h2 class="section-title text-center">Nuestro Catálogo</h2>
      <div class="row mb-4 g-2">
        <div class="col-md-4"><input type="text" id="searchInput" class="form-control" placeholder="Buscar..."></div>
        <div class="col-md-4">
          <select id="categoryFilter" class="form-select">
            <option value="">Todas las categorías</option>
            <option value="Pollo">Pollo</option>
            <option value="Carne">Carne</option>
            <option value="Masas">Masas</option>
            <option value="Platos">Platos</option>
            <option value="Mariscos">Mariscos</option>
            <option value="Ensaladas">Ensaladas</option>
            <option value="Acompañamientos">Acompañamientos</option>
            <option value="Sándwiches">Sándwiches</option>
            <option value="Bebidas">Bebidas</option>
            <option value="Postres">Postres</option>
          </select>
        </div>
        <div class="col-md-4"><button id="clearFilters" class="btn btn-secondary w-100">Limpiar</button></div>
      </div>
      <div id="productList" class="row g-4"></div>
  </section>

  <div class="modal fade" id="productModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="modalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><img id="modalImg" class="img-fluid rounded mb-3" style="max-height:250px"><p id="modalDesc"></p><h4 class="text-primary fw-bold" id="modalPrice"></h4><button id="modalAddBtn" class="btn btn-primary-custom w-100 mt-3">Agregar al Carrito</button></div></div></div></div>
  <div id="toast-container" class="position-fixed top-0 end-0 p-3"></div>

  <footer class="footer-section text-center"><p class="mb-0">&copy; 2025 Rostisería SC</p></footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="api_utils.js"></script>
  <script src="TiempoSesion.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
        let cart = getCart(); const update=()=>document.getElementById('mini-cart-count').textContent=cart.reduce((s,i)=>s+(i.quantity||1),0); update();
        const user = getLoggedUser();
        if(user) {
            if(user.isAdmin) document.getElementById("navAdminItem").classList.remove("d-none");
            document.getElementById("navLoginContainer").innerHTML = `<a class="nav-link mx-2 text-warning" href="#" onclick="clearAuth();window.location.reload()">Salir</a>`;
            const mob = document.getElementById("mobileLoginLink"); if(mob){ mob.textContent="Cerrar Sesión"; mob.onclick=()=>{clearAuth();window.location.reload()};}
        }
        
        function showToast(m){ const d=document.createElement('div'); d.className="toast show bg-success text-white mb-2"; d.innerHTML=`<div class="toast-body">${m}</div>`; document.getElementById('toast-container').appendChild(d); setTimeout(()=>d.remove(),3000); }

        let products = [];
        try {
            const data = await apiFetch('/products', 'GET');
            products = data.map(p => ({id: p._id||p.id, name: p.name, price: p.price, img: p.img||'imagenes/pollo4.jpg', desc: p.description, category: p.category}));
            const render = (list) => {
                const c = document.getElementById('productList'); c.innerHTML="";
                list.forEach(p => c.innerHTML+=`<div class="col-md-4"><div class="card h-100 shadow-sm border-0"><img src="${p.img}" class="card-img-top" style="height:200px;object-fit:cover"><div class="card-body text-center"><h5 class="card-title">${p.name}</h5><p class="text-primary fw-bold">$${p.price.toLocaleString("es-CL")}</p><button class="btn btn-outline-custom btn-sm" onclick="openM('${p.id}')">Ver Detalle</button></div></div></div>`);
            };
            window.openM = (id) => {
                const p = products.find(x=>x.id===id);
                document.getElementById('modalTitle').textContent=p.name; document.getElementById('modalImg').src=p.img; document.getElementById('modalDesc').textContent=p.desc; document.getElementById('modalPrice').textContent="$"+p.price.toLocaleString("es-CL");
                document.getElementById('modalAddBtn').onclick=()=>{ addToCart({id:p.id, name:p.name, price:p.price, quantity:1}); cart=getCart(); update(); showToast("Agregado"); bootstrap.Modal.getInstance(document.getElementById('productModal')).hide(); };
                new bootstrap.Modal(document.getElementById('productModal')).show();
            };
            render(products);
            
            document.getElementById('searchInput').oninput=(e)=>render(products.filter(p=>p.name.toLowerCase().includes(e.target.value.toLowerCase())));
            document.getElementById('categoryFilter').onchange=(e)=>render(products.filter(p=>!e.target.value || p.category===e.target.value));
            document.getElementById('clearFilters').onclick=()=>{document.getElementById('searchInput').value="";document.getElementById('categoryFilter').value="";render(products);};
        } catch(e){console.error(e);}
    });
  </script>
</body>
</html>